<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overland Packing Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-3xl font-bold text-center mb-2 text-primary">Overland Packing Checklist</h1>
        <p class="text-center mb-4 text-gray-600 dark:text-gray-400">Track your packing progress and upload photos of your gear</p>
        
        <!-- Authentication UI -->
        <div id="auth-container" class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
          <div id="login-form">
            <h2 class="text-xl font-semibold mb-4">Login or Sign Up</h2>
            <div class="flex flex-col space-y-3">
              <input id="email-input" type="email" placeholder="Email" class="p-2 border rounded-md text-base text-gray-900 dark:text-white bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600">
              <input id="password-input" type="password" placeholder="Password" class="p-2 border rounded-md text-base text-gray-900 dark:text-white bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600">
              <div class="flex space-x-3">
                <button id="login-btn" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-4 rounded-md">Login</button>
                <button id="signup-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Sign Up</button>
              </div>
              <button id="google-signin-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                  <path fill="#ffffff" d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/>
                </svg>
                Sign in with Google
              </button>
            </div>
            <p id="auth-error" class="text-red-500 mt-2 text-sm hidden"></p>
          </div>
          
          <div id="user-info" class="hidden">
            <div class="flex justify-between items-center">
              <div>
                <h2 class="text-xl font-semibold">Welcome! <span id="user-email"></span></h2>
                <p class="text-sm text-gray-600 dark:text-gray-400">Your lists are automatically synced</p>
              </div>
              <button id="logout-btn" class="text-red-600 hover:text-red-800">Logout</button>
            </div>
          </div>
        </div>
        
        <!-- List Controls -->
        <div id="list-controls" class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-lg shadow hidden">
          <div class="flex items-center justify-between">
            <h3 class="font-medium">Current List: <span id="current-list-name">My Packing List</span></h3>
            <div>
              <button id="new-list-btn" class="text-primary text-sm">+ New List</button>
            </div>
          </div>
          
          <div class="mt-3">
            <button id="share-list-btn" class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-2 px-4 rounded-md transition-colors flex items-center justify-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
              </svg>
              Share This List
            </button>
          </div>
          
          <div id="share-options" class="mt-4 bg-gray-100 dark:bg-gray-700 p-3 rounded-md hidden">
            <p class="text-sm font-medium mb-2">Share Options</p>
            <div class="flex gap-2 mb-3">
              <input id="share-link-input" type="text" readonly class="flex-grow p-2 text-sm bg-white dark:bg-gray-600 border rounded-md text-gray-900 dark:text-white">
              <button id="copy-link-btn" class="bg-green-600 hover:bg-green-700 text-white py-1 px-3 rounded-md text-sm">Copy</button>
            </div>
            <div class="flex justify-between">
              <div class="flex items-center">
                <input id="edit-permission" type="checkbox" class="mr-2">
                <label for="edit-permission" class="text-sm">Allow editing</label>
              </div>
              <button id="close-share-btn" class="text-sm text-gray-600 dark:text-gray-400">Close</button>
            </div>
          </div>
        </div>

        <div class="mb-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Add Custom Item</h2>
            <div class="flex flex-col sm:flex-row gap-2">
                <input id="new-item-input" type="text" placeholder="Enter item name" 
                       class="flex-grow p-2 border rounded-md text-base text-gray-900 dark:text-white bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-primary focus:border-primary">
                <button id="add-item-btn" 
                        class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-4 rounded-md transition-colors">
                    Add Item
                </button>
            </div>
        </div>
        
        <div class="mb-8 bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Share Checklist</h2>
            <div class="flex flex-col sm:flex-row gap-2 mb-2">
                <button id="copy-btn" class="flex-grow bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Copy to Clipboard
                </button>
                <button id="email-btn" class="flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    Share via Email
                </button>
            </div>
            
            <!-- Email Client Selection Modal -->
            <div id="email-modal" class="hidden mt-3 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <p class="text-sm mb-2 font-medium">Select Email Client:</p>
                <div class="grid grid-cols-2 gap-2">
                    <button data-client="default" class="email-client-btn bg-white dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 py-2 px-3 rounded border border-gray-300 dark:border-gray-500 text-sm flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        Default Email
                    </button>
                    <button data-client="gmail" class="email-client-btn bg-white dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 py-2 px-3 rounded border border-gray-300 dark:border-gray-500 text-sm flex items-center">
                        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="#EA4335" xmlns="http://www.w3.org/2000/svg">
                            <path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/>
                        </svg>
                        Gmail
                    </button>
                    <button data-client="outlook" class="email-client-btn bg-white dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 py-2 px-3 rounded border border-gray-300 dark:border-gray-500 text-sm flex items-center">
                        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="#0078D4" xmlns="http://www.w3.org/2000/svg">
                            <path d="M24 7.387v10.478c0 .23-.24.42-.53.42h-8.137v-6.68h3.575v-1.675h-3.575v-1.26c0-.995.602-1.853 1.934-1.853h1.67v-1.488c-.287-.03-1.278-.1-2.434-.1-2.407 0-4.053 1.433-4.053 4.064v1.637h-2.724v1.675h2.724v6.68H.53c-.29 0-.53-.19-.53-.42V7.387c0-.23.24-.42.53-.42h22.94c.29 0 .53.19.53.42z"/>
                        </svg>
                        Outlook
                    </button>
                    <button data-client="yahoo" class="email-client-btn bg-white dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 py-2 px-3 rounded border border-gray-300 dark:border-gray-500 text-sm flex items-center">
                        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="#6001D2" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13.131 21c3.09 0 7.874-1.472 7.874-5.023 0-1.592-1.101-2.422-2.339-2.422-3.09 0-1.945 4.431-5.525 4.431-1.736 0-2.672-1.104-2.672-2.483 0-3.065 3.09-5.023 7.496-5.023-.904.491-1.938 1.472-1.938 2.847 0 1.227.679 1.963 1.87 1.963 2.339 0 1.452-3.65 5.112-3.65 1.32 0 2.203.798 2.203 2.052 0 3.252-4.636 4.308-8.138 4.308-4.7 0-9.147-2.422-9.147-6.975 0-4.308 4.258-7.559 9.712-7.559 5.317 0 9.91 2.97 9.91 7.252 0 4.124-4.433 7.62-9.577 7.62-2.48 0-4.766-.98-6.228-2.545.97 1.043 2.339 1.778 3.984 2.177.846.184.904.245.904 1.104v.616L7.605 21h5.526z"/>
                        </svg>
                        Yahoo
                    </button>
                </div>
                <button id="close-email-modal" class="mt-2 w-full text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">Cancel</button>
            </div>

            <div id="copy-status" class="text-center mt-2 text-green-600 dark:text-green-400 hidden">
                Checklist copied to clipboard!
            </div>
        </div>
        
        <div class="sticky top-0 z-10 bg-gray-50 dark:bg-gray-900 py-2 mb-2">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Your Packing List</h2>
                <div class="flex space-x-2">
                    <button id="expand-all-btn" class="text-primary hover:text-primary/80 text-sm font-medium">Expand All</button>
                    <button id="collapse-all-btn" class="text-primary hover:text-primary/80 text-sm font-medium">Collapse All</button>
                </div>
            </div>
            <div class="mt-2 grid grid-cols-3 gap-2 text-sm">
                <div class="bg-green-100 dark:bg-green-900 px-2 py-1 rounded">
                    <span id="packed-count">0</span> Packed
                </div>
                <div class="bg-blue-100 dark:bg-blue-900 px-2 py-1 rounded">
                    <span id="have-count">0</span> Have
                </div>
                <div class="bg-red-100 dark:bg-red-900 px-2 py-1 rounded">
                    <span id="need-count">0</span> Need
                </div>
            </div>
        </div>
        
        <div id="categories-container" class="space-y-6">
            <!-- Categories and items will be added here dynamically -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase Configuration - REPLACE WITH YOUR OWN CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyCXjWGoFGBcChocW8uvb22N-Br4XBkAHdk",
          authDomain: "kilimanjaro-overland.firebaseapp.com",
          projectId: "kilimanjaro-overland",
          storageBucket: "kilimanjaro-overland.firebasestorage.app",
          messagingSenderId: "668975772707",
          appId: "1:668975772707:web:9c74ec7533c9552fefad96"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Main app logic
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const newItemInput = document.getElementById('new-item-input');
            const addItemBtn = document.getElementById('add-item-btn');
            const categoriesContainer = document.getElementById('categories-container');
            const expandAllBtn = document.getElementById('expand-all-btn');
            const collapseAllBtn = document.getElementById('collapse-all-btn');
            const packedCountEl = document.getElementById('packed-count');
            const haveCountEl = document.getElementById('have-count');
            const needCountEl = document.getElementById('need-count');
            
            // Auth elements
            const loginForm = document.getElementById('login-form');
            const userInfo = document.getElementById('user-info');
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            const loginBtn = document.getElementById('login-btn');
            const signupBtn = document.getElementById('signup-btn');
            const googleSigninBtn = document.getElementById('google-signin-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const authError = document.getElementById('auth-error');
            const userEmail = document.getElementById('user-email');
            
            // List management elements
            const listControls = document.getElementById('list-controls');
            const currentListName = document.getElementById('current-list-name');
            const newListBtn = document.getElementById('new-list-btn');
            const shareListBtn = document.getElementById('share-list-btn');
            const shareOptions = document.getElementById('share-options');
            const shareLinkInput = document.getElementById('share-link-input');
            const copyLinkBtn = document.getElementById('copy-link-btn');
            const editPermission = document.getElementById('edit-permission');
            const closeShareBtn = document.getElementById('close-share-btn');
            
            // Sharing elements
            const copyBtn = document.getElementById('copy-btn');
            const copyStatus = document.getElementById('copy-status');
            const emailBtn = document.getElementById('email-btn');
            const emailModal = document.getElementById('email-modal');
            const closeEmailModalBtn = document.getElementById('close-email-modal');
            const emailClientBtns = document.querySelectorAll('.email-client-btn');
            
            // Initial items data - this will be overridden by Firebase data when authenticated
            let items = [
                // Clothing Category
                {
                    name: 'Navy Overland T-Shirt',
                    quantity: '1',
                    description: 'We will send every student an Overland T-shirt prior to the trip. Please wear this T-shirt to trip start.',
                    category: 'Clothing',
                    status: 'Need It',
                    photoURL: null
                },
                {
                    name: 'Synthetic T-Shirt',
                    quantity: '4',
                    description: 'Please consider cultural sensitivity; you will be expected to have your shoulders covered.',
                    category: 'Clothing',
                    status: 'Need It',
                    photoURL: null
                },
                // ... more initial items
            ];
            
            let expandedCategories = new Set();
            
            // AUTH FUNCTIONALITY
            
            // Handle login
            loginBtn.addEventListener('click', () => {
              const email = emailInput.value.trim();
              const password = passwordInput.value.trim();
              
              if (!email || !password) {
                showAuthError('Please enter both email and password');
                return;
              }
              
              auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                  showAuthError(`Login failed: ${error.message}`);
                });
            });
            
            // Handle signup
            signupBtn.addEventListener('click', () => {
              const email = emailInput.value.trim();
              const password = passwordInput.value.trim();
              
              if (!email || !password) {
                showAuthError('Please enter both email and password');
                return;
              }
              
              if (password.length < 6) {
                showAuthError('Password must be at least 6 characters');
                return;
              }
              
              auth.createUserWithEmailAndPassword(email, password)
                .catch(error => {
                  showAuthError(`Signup failed: ${error.message}`);
                });
            });
            
            // Handle Google signin
            googleSigninBtn.addEventListener('click', () => {
              const provider = new firebase.auth.GoogleAuthProvider();
              auth.signInWithPopup(provider)
                .catch(error => {
                  showAuthError(`Google sign-in failed: ${error.message}`);
                });
            });
            
            // Handle logout
            logoutBtn.addEventListener('click', () => {
              auth.signOut();
            });
            
            // Show auth error message
            function showAuthError(message) {
              authError.textContent = message;
              authError.classList.remove('hidden');
            }
            
            // Monitor auth state
            auth.onAuthStateChanged(user => {
              if (user) {
                // User is signed in
                userEmail.textContent = user.email;
                loginForm.classList.add('hidden');
                userInfo.classList.remove('hidden');
                listControls.classList.remove('hidden');
                
                // Load user's lists
                loadUserLists(user.uid);
              } else {
                // User is signed out
                loginForm.classList.remove('hidden');
                userInfo.classList.add('hidden');
                listControls.classList.add('hidden');
                emailInput.value = '';
                passwordInput.value = '';
                authError.classList.add('hidden');
                
                // Clear any items listener
                if (window.itemsListener) {
                  window.itemsListener();
                  window.itemsListener = null;
                }
                
                // Show initial items
                updateUI();
              }
            });
            
            // FIREBASE DATABASE FUNCTIONALITY
            
            // Create a new list
            async function createList(userId, listName = 'My Packing List') {
              try {
                const listRef = await db.collection('lists').add({
                  name: listName,
                  ownerId: userId,
                  shared: false,
                  created: firebase.firestore.FieldValue.serverTimestamp(),
                  lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Use default items for new list
                for (const item of getDefaultItems()) {
                  await db.collection('lists').doc(listRef.id).collection('items').add({
                    name: item.name,
                    quantity: item.quantity,
                    description: item.description,
                    category: item.category,
                    status: item.status,
                    photoURL: null,
                    created: firebase.firestore.FieldValue.serverTimestamp(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                  });
                }
                
                return listRef.id;
              } catch (error) {
                console.error('Error creating list:', error);
                return null;
              }
            }
            
            // Load user's lists
            async function loadUserLists(userId) {
              try {
                // Check if user has any lists
                const listsSnapshot = await db.collection('lists')
                  .where('ownerId', '==', userId)
                  .orderBy('lastUpdated', 'desc')
                  .limit(1)
                  .get();
                
                let currentListId;
                
                // If no lists exist, create a default one
                if (listsSnapshot.empty) {
                  currentListId = await createList(userId);
                  currentListName.textContent = 'My Packing List';
                } else {
                  const listDoc = listsSnapshot.docs[0];
                  currentListId = listDoc.id;
                  currentListName.textContent = listDoc.data().name;
                }
                
                // Start real-time listener for the current list
                if (currentListId) {
                  loadListItems(currentListId);
                }
              } catch (error) {
                console.error('Error loading user lists:', error);
              }
            }
            
            // Load items from a specific list
            function loadListItems(listId) {
              // Clear previous listener if any
              if (window.itemsListener) {
                window.itemsListener();
              }
              
              // Store current list ID
              window.currentListId = listId;
              
              // Create real-time listener for items
              window.itemsListener = db.collection('lists').doc(listId)
                .collection('items')
                .orderBy('category')
                .onSnapshot(snapshot => {
                  // Convert to our items format
                  items = snapshot.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().name,
                    quantity: doc.data().quantity,
                    description: doc.data().description,
                    category: doc.data().category,
                    status: doc.data().status,
                    photoURL: doc.data().photoURL
                  }));
                  
                  // Update the UI
                  updateUI();
                }, error => {
                  console.error('Error loading items:', error);
                });
            }
            
            // Get default items for new list
            function getDefaultItems() {
              return [
                // Clothing Category
                {
                    name: 'Navy Overland T-Shirt',
                    quantity: '1',
                    description: 'We will send every student an Overland T-shirt prior to the trip. Please wear this T-shirt to trip start.',
                    category: 'Clothing',
                    status: 'Need It',
                    photoURL: null
                },
                {
                    name: 'Synthetic T-Shirt',
                    quantity: '4',
                    description: 'Please consider cultural sensitivity; you will be expected to have your shoulders covered.',
                    category: 'Clothing',
                    status: 'Need It',
                    photoURL: null
                },
                {
                    name: 'Synthetic Long-Sleeve T-shirt',
                    quantity: '1',
                    description: '',
                    category: 'Clothing',
                    status: 'Need It',
                    photoURL: null
                },
                {
                    name: 'Synthetic Shorts',
                    quantity: '2',
                    description: '',
                    category: 'Clothing',
                    status: 'Need It',
                    photoURL: null
                },
                {
                    name: 'Synthetic Hiking Pants',
                    quantity: '2',
                    description: 'Lightweight and quick dry material. Non-cotton warmup style pants are acceptable.',
                    category: 'Clothing',
                    status: 'Need It',
                    photoURL: null
                },
                // Outer Layers Category
                {
                    name: 'Fleece Jacket or Pullover',
                    quantity: '1',
                    description: '',
                    category: 'Outer Layers',
                    status: 'Need It',
                    photoURL: null
                },
                {
                    name: 'Raincoat',
                    quantity: '1',
                    description: 'Waterproof material (e.g., Gore-Tex, or similar) is required.',
                    category: 'Outer Layers',
                    status: 'Need It',
                    photoURL: null
                },
                // Footwear Category
                {
                    name: 'Waterproof Hiking Boots',
                    quantity: '1 pair',
                    description: 'Choose comfortable boots designed for hiking with a pack.',
                    category: 'Footwear',
                    status: 'Need It',
                    photoURL: null
                },
                {
                    name: 'Sneakers',
                    quantity: '1 pair',
                    description: 'Comfortable shoes with good traction.',
                    category: 'Footwear',
                    status: 'Need It',
                    photoURL: null
                }
              ];
            }
            
            // Function to update the UI based on items array
            function updateUI() {
                categoriesContainer.innerHTML = '';
                
                // Group items by category
                const categories = {};
                items.forEach(item => {
                    if (!categories[item.category]) {
                        categories[item.category] = [];
                    }
                    categories[item.category].push(item);
                });
                
                // Update counts
                const packedCount = items.filter(item => item.status === 'Packed It').length;
                const haveCount = items.filter(item => item.status === 'Have It').length;
                const needCount = items.filter(item => item.status === 'Need It').length;
                
                packedCountEl.textContent = packedCount;
                haveCountEl.textContent = haveCount;
                needCountEl.textContent = needCount;
                
                // Create category sections
                Object.entries(categories).forEach(([category, categoryItems]) => {
                    const categoryElement = document.createElement('div');
                    categoryElement.className = 'bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden';
                    
                    // Category header
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'bg-gray-100 dark:bg-gray-700 px-4 py-3 flex justify-between items-center cursor-pointer';
                    categoryHeader.addEventListener('click', () => {
                        const contentDiv = categoryElement.querySelector('.category-content');
                        if (contentDiv.style.display === 'none') {
                            contentDiv.style.display = 'block';
                            expandedCategories.add(category);
                            const icon = categoryHeader.querySelector('svg');
                            icon.style.transform = 'rotate(180deg)';
                        } else {
                            contentDiv.style.display = 'none';
                            expandedCategories.delete(category);
                            const icon = categoryHeader.querySelector('svg');
                            icon.style.transform = 'rotate(0deg)';
                        }
                    });
                    
                    const categoryTitle = document.createElement('h3');
                    categoryTitle.className = 'font-medium text-lg';
                    categoryTitle.textContent = category;
                    
                    const categoryCounter = document.createElement('div');
                    categoryCounter.className = 'flex items-center';
                    
                    const categoryCount = document.createElement('span');
                    categoryCount.className = 'text-sm mr-2';
                    categoryCount.textContent = `${categoryItems.length} items`;
                    
                    const chevronIcon = document.createElement('div');
                    chevronIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>';
                    
                    categoryCounter.appendChild(categoryCount);
                    categoryCounter.appendChild(chevronIcon);
                    
                    categoryHeader.appendChild(categoryTitle);
                    categoryHeader.appendChild(categoryCounter);
                    
                    // Category content
                    const categoryContent = document.createElement('div');
                    categoryContent.className = 'category-content divide-y divide-gray-200 dark:divide-gray-700';
                    if (!expandedCategories.has(category)) {
                        categoryContent.style.display = 'none';
                    } else {
                        const icon = chevronIcon.querySelector('svg');
                        icon.style.transform = 'rotate(180deg)';
                    }
                    
                    // Add items to category
                    categoryItems.forEach((item) => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'p-4';
                        
                        // Create header with item name and delete button
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'flex justify-between items-start mb-2';
                        
                        const itemNameDiv = document.createElement('div');
                        itemNameDiv.className = 'flex-grow';
                        
                        const itemName = document.createElement('h4');
                        itemName.className = 'text-lg font-medium';
                        itemName.textContent = `${item.name} (${item.quantity})`;
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'text-red-500 hover:text-red-700 transition-colors ml-2 flex-shrink-0 delete-btn';
                        deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>';
                        
                        // Delete functionality
                        deleteBtn.addEventListener('click', async () => {
                            // Check if we're authenticated and have a list ID
                            if (window.currentListId && auth.currentUser) {
                                try {
                                    await db.collection('lists').doc(window.currentListId)
                                        .collection('items').doc(item.id).delete();
                                    
                                    // Update the list's last updated timestamp
                                    await db.collection('lists').doc(window.currentListId).update({
                                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    
                                    // UI will update automatically via the listener
                                } catch (error) {
                                    console.error('Error deleting item:', error);
                                }
                            } else {
                                // Fallback for non-auth mode
                                items = items.filter(i => i.id !== item.id);
                                updateUI();
                            }
                        });
                        
                        itemNameDiv.appendChild(itemName);
                        
                        headerDiv.appendChild(itemNameDiv);
                        headerDiv.appendChild(deleteBtn);
                        
                        // Description
                        const description = document.createElement('p');
                        description.className = 'text-sm text-gray-600 dark:text-gray-400 mb-3';
                        description.textContent = item.description || 'No description provided';
                        
                        // Create status buttons
                        const statusDiv = document.createElement('div');
                        statusDiv.className = 'flex flex-wrap gap-2 mb-4';
                        
                        const statuses = ['Need It', 'Have It', 'Packed It'];
                        statuses.forEach(status => {
                            const statusBtn = document.createElement('button');
                            statusBtn.classList.add('status-btn');
                            
                            if (item.status === status) {
                                statusBtn.className = 'px-3 py-1 rounded-full text-white status-btn';
                                if (status === 'Need It') {
                                    statusBtn.classList.add('bg-red-500');
                                } else if (status === 'Have It') {
                                    statusBtn.classList.add('bg-blue-500');
                                } else if (status === 'Packed It') {
                                    statusBtn.classList.add('bg-green-500');
                                }
                            } else {
                                statusBtn.className = 'px-3 py-1 rounded-full text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors status-btn';
                            }
                            
                            statusBtn.textContent = status;
                            
                            // Status button functionality
                            statusBtn.addEventListener('click', async () => {
                                // Check if we're authenticated and have a list ID
                                if (window.currentListId && auth.currentUser) {
                                    try {
                                        // If changing from a status that required a photo to "Need It", remove the photo
                                        let photoURL = item.photoURL;
                                        if (status === 'Need It' && (item.status === 'Have It' || item.status === 'Packed It')) {
                                            photoURL = null;
                                        }
                                        
                                        await db.collection('lists').doc(window.currentListId)
                                            .collection('items').doc(item.id).update({
                                                status: status,
                                                photoURL: photoURL,
                                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                                            });
                                        
                                        // Update the list's last updated timestamp
                                        await db.collection('lists').doc(window.currentListId).update({
                                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                                        });
                                        
                                        // UI will update automatically via the listener
                                    } catch (error) {
                                        console.error('Error updating item status:', error);
                                    }
                                } else {
                                    // Fallback for non-auth mode
                                    // If changing from a status that required a photo to "Need It", remove the photo
                                    if (status === 'Need It' && (item.status === 'Have It' || item.status === 'Packed It')) {
                                        item.photoURL = null;
                                    }
                                    
                                    item.status = status;
                                    updateUI();
                                }
                            });
                            
                            statusDiv.appendChild(statusBtn);
                        });
                        
                        // Create photo upload section if "Have It" or "Packed It" is selected
                        let photoDiv = document.createElement('div');
                        photoDiv.className = 'photo-upload';
                        
                        if (item.status === 'Have It' || item.status === 'Packed It') {
                            photoDiv.className = 'mt-4 photo-upload';
                            
                            if (item.photoURL) {
                                // Display the photo if it exists
                                const photoContainer = document.createElement('div');
                                photoContainer.className = 'mb-2';
                                
                                const photo = document.createElement('img');
                                photo.src = item.photoURL;
                                photo.className = 'w-full max-h-48 object-contain rounded-md';
                                photo.alt = item.name;
                                
                                photoContainer.appendChild(photo);
                                photoDiv.appendChild(photoContainer);
                                
                                // Add button to change photo
                                const changePhotoBtn = document.createElement('button');
                                changePhotoBtn.className = 'text-primary text-sm underline mb-2 block';
                                changePhotoBtn.textContent = 'Change Photo';
                                
                                // Photo change functionality 
                                changePhotoBtn.addEventListener('click', async () => {
                                    if (window.currentListId && auth.currentUser) {
                                        try {
                                            await db.collection('lists').doc(window.currentListId)
                                                .collection('items').doc(item.id).update({
                                                    photoURL: null,
                                                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                                                });
                                            
                                            // Update the list's last updated timestamp
                                            await db.collection('lists').doc(window.currentListId).update({
                                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                                            });
                                            
                                            // UI will update automatically via the listener
                                        } catch (error) {
                                            console.error('Error removing photo:', error);
                                        }
                                    } else {
                                        // Fallback for non-auth mode
                                        item.photoURL = null;
                                        updateUI();
                                    }
                                });
                                
                                photoDiv.appendChild(changePhotoBtn);
                            } else {
                                // Show photo upload input
                                const uploadLabel = document.createElement('p');
                                uploadLabel.className = 'mb-2 font-medium';
                                uploadLabel.textContent = `Please upload a photo of your ${item.name}:`;
                                
                                const fileInput = document.createElement('input');
                                fileInput.type = 'file';
                                fileInput.accept = 'image/*';
                                fileInput.className = 'block w-full text-sm text-gray-900 dark:text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary/90';
                                
                                // File upload functionality
                                fileInput.addEventListener('change', async (event) => {
                                    const file = event.target.files[0];
                                    if (!file) return;
                                    
                                    if (window.currentListId && auth.currentUser) {
                                        try {
                                            // Show loading state
                                            const loadingEl = document.createElement('p');
                                            loadingEl.textContent = 'Uploading photo...';
                                            loadingEl.className = 'text-sm text-gray-600 dark:text-gray-400';
                                            photoDiv.appendChild(loadingEl);
                                            
                                            // Upload to Firebase Storage
                                            const storageRef = storage.ref(`lists/${window.currentListId}/items/${item.id}`);
                                            const fileRef = storageRef.child(`${Date.now()}_${file.name}`);
                                            const snapshot = await fileRef.put(file);
                                            const photoURL = await snapshot.ref.getDownloadURL();
                                            
                                            // Update item with photo URL
                                            await db.collection('lists').doc(window.currentListId)
                                                .collection('items').doc(item.id).update({
                                                    photoURL: photoURL,
                                                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                                                });
                                            
                                            // Update list timestamp
                                            await db.collection('lists').doc(window.currentListId).update({
                                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                                            });
                                            
                                            // UI will update automatically via the listener
                                        } catch (error) {
                                            console.error('Error uploading photo:', error);
                                            alert('Failed to upload photo. Please try again.');
                                        }
                                    } else {
                                        // Fallback for non-auth mode
                                        const reader = new FileReader();
                                        reader.onload = (e) => {
                                            item.photoURL = e.target.result;
                                            updateUI();
                                        };
                                        reader.readAsDataURL(file);
                                    }
                                });
                                
                                photoDiv.appendChild(uploadLabel);
                                photoDiv.appendChild(fileInput);
                            }
                        }
                        
                        // Append all elements to the item container
                        itemElement.appendChild(headerDiv);
                        itemElement.appendChild(description);
                        itemElement.appendChild(statusDiv);
                        itemElement.appendChild(photoDiv);
                        
                        categoryContent.appendChild(itemElement);
                    });
                    
                    categoryElement.appendChild(categoryHeader);
                    categoryElement.appendChild(categoryContent);
                    categoriesContainer.appendChild(categoryElement);
                });
                
                // For shared lists with view-only permission, adjust UI
                if (window.isSharedList && !window.canEdit) {
                    // Hide delete buttons
                    document.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.classList.add('hidden');
                    });
                    
                    // Disable status buttons
                    document.querySelectorAll('.status-btn').forEach(btn => {
                        btn.disabled = true;
                        btn.classList.add('opacity-50');
                    });
                    
                    // Hide photo uploads
                    document.querySelectorAll('.photo-upload').forEach(el => {
                        el.classList.add('hidden');
                    });
                    
                    // Disable item input
                    newItemInput.disabled = true;
                    addItemBtn.disabled = true;
                    addItemBtn.classList.add('opacity-50');
                }
            }
            
            // Add a new item
            async function addNewItem() {
                const itemName = newItemInput.value.trim();
                
                if (itemName === '') return;
                
                if (window.currentListId && auth.currentUser) {
                    try {
                        await db.collection('lists').doc(window.currentListId)
                          .collection('items').add({
                            name: itemName,
                            quantity: '1',
                            description: '',
                            category: 'Custom Items',
                            status: 'Need It',
                            photoURL: null,
                            created: firebase.firestore.FieldValue.serverTimestamp(),
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                          });
                        
                        // Update the list's last updated timestamp
                        await db.collection('lists').doc(window.currentListId).update({
                          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Expand the Custom Items category
                        expandedCategories.add('Custom Items');
                        
                        // Clear input
                        newItemInput.value = '';
                        
                        // UI will update automatically via the onSnapshot listener
                    } catch (error) {
                        console.error('Error adding item:', error);
                    }
                } else {
                    // Fallback for non-auth mode
                    items.push({
                        id: Date.now().toString(), // Generate a temp ID
                        name: itemName,
                        quantity: '1',
                        description: '',
                        category: 'Custom Items',
                        status: 'Need It',
                        photoURL: null
                    });
                    
                    // Expand the Custom Items category
                    expandedCategories.add('Custom Items');
                    
                    newItemInput.value = '';
                    updateUI();
                }
            }
            
            // LIST SHARING FUNCTIONALITY
            
            // Create new list
            newListBtn.addEventListener('click', async () => {
                const listName = prompt('Enter a name for your new list:');
                if (listName && auth.currentUser) {
                    const listId = await createList(auth.currentUser.uid, listName);
                    if (listId) {
                        currentListName.textContent = listName;
                        loadListItems(listId);
                    }
                }
            });
            
            // Share list
            shareListBtn.addEventListener('click', async () => {
                if (!window.currentListId || !auth.currentUser) return;
                
                try {
                    // Generate a unique share ID
                    const shareId = generateSharedId();
                    
                    // Update the list to be shared
                    await db.collection('lists').doc(window.currentListId).update({
                        shared: true,
                        shareId: shareId,
                        allowEdit: editPermission.checked,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Generate a shareable link
                    const shareLink = `${window.location.origin}?list=${shareId}`;
                    shareLinkInput.value = shareLink;
                    
                    // Show share options
                    shareOptions.classList.remove('hidden');
                } catch (error) {
                    console.error('Error sharing list:', error);
                    alert('Failed to share list. Please try again.');
                }
            });
            
            // Copy share link
            copyLinkBtn.addEventListener('click', () => {
                shareLinkInput.select();
                document.execCommand('copy');
                copyLinkBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyLinkBtn.textContent = 'Copy';
                }, 2000);
            });
            
            // Toggle edit permission
            editPermission.addEventListener('change', async () => {
                if (!window.currentListId || !auth.currentUser) return;
                
                try {
                    await db.collection('lists').doc(window.currentListId).update({
                        allowEdit: editPermission.checked,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error updating share permissions:', error);
                }
            });
            
            // Close share options
            closeShareBtn.addEventListener('click', () => {
                shareOptions.classList.add('hidden');
            });
            
            // Generate a unique shared ID
            function generateSharedId() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < 10; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }
            
            // Check for shared list in URL
            function checkForSharedList() {
                const urlParams = new URLSearchParams(window.location.search);
                const sharedListId = urlParams.get('list');
                
                if (sharedListId) {
                    loadSharedList(sharedListId);
                }
            }
            
            // Load a shared list
            async function loadSharedList(shareId) {
                try {
                    // Find the list with this share ID
                    const listQuery = await db.collection('lists')
                        .where('shareId', '==', shareId)
                        .where('shared', '==', true)
                        .limit(1)
                        .get();
                    
                    if (!listQuery.empty) {
                        const listDoc = listQuery.docs[0];
                        const listData = listDoc.data();
                        
                        // Update UI to show this is a shared list
                        currentListName.textContent = `${listData.name} (Shared)`;
                        
                        // Load the items
                        window.currentListId = listDoc.id;
                        window.isSharedList = true;
                        window.canEdit = listData.allowEdit;
                        
                        // Show the list controls
                        listControls.classList.remove('hidden');
                        
                        // Hide sharing controls for shared list viewers
                        shareListBtn.classList.add('hidden');
                        
                        loadListItems(listDoc.id);
                    } else {
                        alert('Shared list not found or no longer available.');
                    }
                } catch (error) {
                    console.error('Error loading shared list:', error);
                    alert('Failed to load shared list.');
                }
            }
            
            // STANDARD LIST FUNCTIONALITY
            
            // Generate formatted text for sharing
            function generateFormattedList() {
                // Group items by category
                const categories = {};
                items.forEach(item => {
                    if (!categories[item.category]) {
                        categories[item.category] = [];
                    }
                    categories[item.category].push(item);
                });
                
                let formattedText = "OVERLAND PACKING CHECKLIST\n\n";
                
                // Add shared list info if applicable
                if (window.currentListId && window.isSharedList) {
                    formattedText += `Shared List: ${currentListName.textContent}\n`;
                    formattedText += `List URL: ${window.location.href}\n\n`;
                }
                
                // Add summary
                const packedCount = items.filter(item => item.status === 'Packed It').length;
                const haveCount = items.filter(item => item.status === 'Have It').length;
                const needCount = items.filter(item => item.status === 'Need It').length;
                formattedText += `Summary: ${packedCount} Packed | ${haveCount} Have | ${needCount} Need\n\n`;
                
                // Add items by category
                Object.entries(categories).forEach(([category, categoryItems]) => {
                    formattedText += `${category.toUpperCase()}\n${'-'.repeat(category.length)}\n`;
                    
                    categoryItems.forEach(item => {
                        // Add status indicator
                        let statusSymbol = '[ ] '; // Need It
                        if (item.status === 'Have It') statusSymbol = '[✓] ';
                        if (item.status === 'Packed It') statusSymbol = '[✓✓] ';
                        
                        // Add item details
                        formattedText += `${statusSymbol}${item.name} (${item.quantity})`;
                        if (item.description && item.description.trim() !== '') {
                            formattedText += `\n    ${item.description}`;
                        }
                        formattedText += '\n';
                    });
                    formattedText += '\n';
                });
                
                // Add legend
                formattedText += "Status Legend:\n";
                formattedText += "[ ] = Need It | [✓] = Have It | [✓✓] = Packed It\n\n";
                formattedText += "Created with Overland Packing Checklist";
                
                return formattedText;
            }
            
            // Share via clipboard
            copyBtn.addEventListener('click', () => {
                const formattedList = generateFormattedList();
                
                // Use the Clipboard API to copy the text
                navigator.clipboard.writeText(formattedList)
                    .then(() => {
                        // Show success message
                        copyStatus.textContent = "Checklist copied to clipboard!";
                        copyStatus.classList.remove('hidden');
                        
                        // Hide message after 3 seconds
                        setTimeout(() => {
                            copyStatus.classList.add('hidden');
                        }, 3000);
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        copyStatus.textContent = "Failed to copy. Try again.";
                        copyStatus.classList.remove('hidden');
                        setTimeout(() => {
                            copyStatus.classList.add('hidden');
                        }, 3000);
                    });
            });
            
            // Email modal functionality
            emailBtn.addEventListener('click', () => {
                emailModal.classList.remove('hidden');
            });
            
            // Close email modal
            closeEmailModalBtn.addEventListener('click', () => {
                emailModal.classList.add('hidden');
            });
            
            // Handle email client selection
            emailClientBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const client = btn.getAttribute('data-client');
                    const formattedList = generateFormattedList();
                    const subject = encodeURIComponent("Overland Packing Checklist");
                    const body = encodeURIComponent(formattedList);
                    
                    let emailUrl = '';
                    
                    switch(client) {
                        case 'gmail':
                            emailUrl = `https://mail.google.com/mail/u/0/?view=cm&fs=1&tf=1&su=${subject}&body=${body}`;
                            break;
                        case 'outlook':
                            emailUrl = `https://outlook.live.com/mail/0/deeplink/compose?subject=${subject}&body=${body}`;
                            break;
                        case 'yahoo':
                            emailUrl = `https://compose.mail.yahoo.com/?subject=${subject}&body=${body}`;
                            break;
                        default:
                            // Default email client
                            emailUrl = `mailto:?subject=${subject}&body=${body}`;
                    }
                    
                    // Open the email client
                    window.open(emailUrl, '_blank');
                    
                    // Hide the modal after selection
                    emailModal.classList.add('hidden');
                });
            });
            
            // Event listeners
            addItemBtn.addEventListener('click', addNewItem);
            
            newItemInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addNewItem();
                }
            });
            
            expandAllBtn.addEventListener('click', () => {
                items.forEach(item => {
                    expandedCategories.add(item.category);
                });
                updateUI();
            });
            
            collapseAllBtn.addEventListener('click', () => {
                expandedCategories.clear();
                updateUI();
            });
            
            // Initialize
            updateUI();
            checkForSharedList();
        });
    </script>
</body>
</html>
